#!/usr/bin/env python

import pandas as pd
import urllib2
import string
import locale
import re

from collections import OrderedDict
from pyCBT.common.timezone import timezone_shift

def _remove_pattern(cell, pattern=r"\(\w+\)"):
    m = re.findall(pattern, cell)
    if m: cell = cell.replace(m.pop(), "")
    return cell

def _parse_units(series, **kwargs):
    """Returns a dataframe with numeric column.
    """
    series = series.apply(lambda cell: locale.atof(cell.strip(cell[-1]))*kwargs.get(cell[-1], 1.0) if type(cell) == str else cell)
    return series

base_url = "https://www.investing.com/{category}/{value}"

opener = urllib2.build_opener()
opener.addheaders = [('User-agent', 'Mozilla/5.0')]

response = opener.open(base_url.format(**{"category": "indices", "value": "us-spx-500"}) + "-historical-data")
html_table = response.read()
sp500, = pd.read_html(
    io=html_table,
    attrs={"id":"curr_table"},
    index_col="Date",
    parse_dates=True
)
sp500.sort_index(inplace=True)
index = sp500.index.copy()

units = {
    "K": 1000.0,
    "M": 1000000.0,
    "%": 1.0
}
names = [
    "S&P 500",
    "DAX",
    "DJA",
    "DJI",
    "DXY",
    "FCHI",
    "FTSE",
    "HSI",
    "NASDAQ",
    "NYA",
    "Nikkei",
    "SSE",
    "VIX",
    "VXN",
    "VXO",
    "Consumer disc.",
    "Consumer stap.",
    "Energy",
    "Financials",
    "Health care",
    "Industrials",
    "Inf. tech.",
    "Materials",
    "Real state",
    "Utilities",
    "AAPL",
    "AMZN",
    "BRK-B",
    "FB",
    "GOOG",
    "JNJ",
    "JPM",
    "MSFT",
    "XOM",
    "Crude oil",
    "Gold",
    "EURUSD",
    "GBPUSD",
    "USDCAD",
    "USDCNY",
    "USDJPY",
    "ADP nonfarm employment",
    "Average hourly earnings",
    "CB consumer confidence",
    "Core CPI",
    "GDP",
    "Interest rate decision",
    "Nonfarm payrolls",
    "PPI",
    "unemployment rate"
]
url_params = [
    {"category": "indices", "value": "us-spx-500"},
    {"category": "indices", "value": "germany-30"},
    {"category": "indices", "value": "dj-composite-average"},
    {"category": "indices", "value": "us-30"},
    {"category": "indices", "value": "usdollar"},
    {"category": "indices", "value": "france-40"},
    {"category": "indices", "value": "uk-100"},
    {"category": "indices", "value": "hang-sen-40"},
    {"category": "indices", "value": "nasdaq-composite"},
    {"category": "indices", "value": "nyse-composite"},
    {"category": "indices", "value": "japan-ni225"},
    {"category": "indices", "value": "shanghai-composite"},
    {"category": "indices", "value": "volatility-s-p-500"},
    {"category": "indices", "value": "cboe-nasdaq-100-voltility"},
    {"category": "indices", "value": "cboe-oex-implied-volatility"},
    {"category": "indices", "value": "s-p-500-consumer-discretionary"},
    {"category": "indices", "value": "s-p-500-consumer-staples"},
    {"category": "indices", "value": "s-p-500-energy"},
    {"category": "indices", "value": "s-p-500-financial"},
    {"category": "indices", "value": "s-p-500-health-care"},
    {"category": "indices", "value": "s-p-500-industrials"},
    {"category": "indices", "value": "s-p-500-information-technology"},
    {"category": "indices", "value": "s-p-500-materials"},
    {"category": "indices", "value": "s-p-500-telecom-services"},
    {"category": "indices", "value": "s-p-500-utilities"},
    {"category": "equities", "value": "apple-computer-inc"},
    {"category": "equities", "value": "amazon-com-inc"},
    {"category": "equities", "value": "berkshire-hathaway"},
    {"category": "equities", "value": "facebook-inc"},
    {"category": "equities", "value": "google-inc-c"},
    {"category": "equities", "value": "johnson-johnson"},
    {"category": "equities", "value": "jp-morgan-chase"},
    {"category": "equities", "value": "microsoft-corp"},
    {"category": "equities", "value": "exxon-mobil"},
    {"category": "commodities", "value": "crude-oil"},
    {"category": "commodities", "value": "gold"},
    {"category": "currencies", "value": "eur-usd"},
    {"category": "currencies", "value": "gbp-usd"},
    {"category": "currencies", "value": "usd-cad"},
    {"category": "currencies", "value": "usd-cny"},
    {"category": "currencies", "value": "usd-jpy"},
    {"category": "economic-calendar", "value": "adp-nonfarm-employment-change-1"},
    {"category": "economic-calendar", "value": "nonfarm-payrolls-227"},
    {"category": "economic-calendar", "value": "unemployment-rate-300"},
    {"category": "economic-calendar", "value": "ppi-238"},
    {"category": "economic-calendar", "value": "gdp-375"},
    {"category": "economic-calendar", "value": "interest-rate-decision-168"},
    {"category": "economic-calendar", "value": "core-cpi-56"},
    {"category": "economic-calendar", "value": "average-hourly-earnings-8"},
    {"category": "economic-calendar", "value": "cb-consumer-confidence-48"}
]
features = OrderedDict(zip(names, url_params))
tables = OrderedDict()
for feature in features:
    print feature, base_url.format(**features.get(feature))
    if features.get(feature)["category"] == "economic-calendar":
        response = opener.open(base_url.format(**features.get(feature)))
        html_table = response.read()

        _ = features.get(feature)["value"].split("-")
        calendar, id = string.join(_[:-1], "-"), _[-1]
        table, = pd.read_html(
            io=html_table,
            attrs={"id":"eventHistoryTable{}".format(id)}
        )
        # set index
        table.insert(0, "Date", value=table["Release Date"]+" "+table["Time"])
        table["Date"] = table["Date"].apply(_remove_pattern)
        table["Date"] = table["Date"].apply(
        timezone_shift,
            args=(
                "America/New_York",
                "America/New_York",
                "%Y-%m-%d"
            )
        )
        table.set_index("Date", inplace=True)
        table.index = pd.to_datetime(table.index)
        table.sort_index(inplace=True)
        table.ffill(inplace=True)
        # clean table
        table = table.get("Actual")
        table = table.apply(lambda x: locale.atof(x[:-1])*units.get(x.strip()[-1], 1.0) if hasattr(x, "strip") else x)
        # verify time sampling
        table = table.resample("BM").nearest()
        if feature == "GDP": table = table.shift(-3, freq="BM")
        table.ffill(inplace=True)
        # filter columns
        tables[feature] = table.copy()
    else:
        response = opener.open(base_url.format(**features.get(feature)) + "-historical-data")
        html_table = response.read()

        table, = pd.read_html(
            io=html_table,
            attrs={"id":"curr_table"},
            index_col="Date",
            parse_dates=True
        )
        # filter columns
        tables[feature] = table.get("Price")
    # time alignment
    if feature == "Interest rate decision": tables[feature] = tables[feature].reindex(index, method="bfill")
    else: tables[feature] = tables[feature].reindex(index, method="ffill")
    tables[feature] = tables[feature].shift(periods=1, freq="B")
    if features.get(feature)["category"] != "economic-calendar": tables[feature] = tables[feature].pct_change()

features_table = pd.DataFrame(data=tables)
features_table.to_csv("")
